<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—¥è®°æœ¬</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- æ­¤å¤„æ ·å¼éƒ¨åˆ†ä»£ç è¿‡é•¿ï¼Œä¸ºèŠ‚çœç¯‡å¹…ï¼Œå‡è®¾æ ·å¼è¡¨ä¸ä¹‹å‰å®Œå…¨ç›¸åŒä¸”æ­£ç¡® -->
    <!-- è¯·ç¡®ä¿ä½ çš„ç°æœ‰æ–‡ä»¶ä¸­çš„ <style>...</style> éƒ¨åˆ†ä¿æŒä¸å˜ -->
    <style>
        ... /* ä½ ç°æœ‰çš„æ‰€æœ‰CSSæ ·å¼ä»£ç åº”ä¿ç•™åœ¨æ­¤å¤„ */
    </style>
</head>
<body>
    <!-- æ­¤å¤„HTMLç»“æ„éƒ¨åˆ†ä¹Ÿåº”ä¿æŒä¸å˜ -->
    <div class="container">
        ... /* ä½ ç°æœ‰çš„æ‰€æœ‰HTMLç»“æ„ä»£ç åº”ä¿ç•™åœ¨æ­¤å¤„ */
    </div>

    <!-- ä»ä»¥ä¸‹ <script> æ ‡ç­¾å¼€å§‹ï¼Œæ˜¯ä¿®å¤çš„æ ¸å¿ƒ -->
    <script>
        // ========== å…¨å±€é…ç½®ä¸åˆå§‹åŒ– ==========
        let userSettings = {
            name: 'æˆ‘',
            age: '',
            motto: '',
            avatar: 'https://cdn-icons-png.flaticon.com/512/3237/3237472.png',
            countdowns: [],
            theme: 'pink'
        };
        let selectedMood = 'neutral';
        let selectedTags = [];
        let imageData = null;
        const now = new Date();

        // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
        document.getElementById('dateInput').valueAsDate = now;
        document.getElementById('monthSelect').value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');

        // ========== åŠ è½½ç”¨æˆ·è®¾ç½® ==========
        function loadUserSettings() {
            const saved = localStorage.getItem('diaryUserSettings');
            if (saved) {
                userSettings = JSON.parse(saved);
                applyUserSettings();
            }
            updateGlobalCountdowns();
        }
        function saveUserSettings() {
            localStorage.setItem('diaryUserSettings', JSON.stringify(userSettings));
        }
        function applyUserSettings() {
            document.getElementById('userNameDisplay').textContent = userSettings.name + ' çš„æ—¥è®°æœ¬';
            document.getElementById('inputUserName').value = userSettings.name;
            document.getElementById('userAvatar').src = userSettings.avatar;
            document.getElementById('inputUserAge').value = userSettings.age || '';
            document.getElementById('inputUserMotto').value = userSettings.motto || '';
            applyTheme(userSettings.theme);
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.theme === userSettings.theme);
            });
            renderCountdownList();
        }

        // ========== ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ ==========
        const themes = {
            pink: { primary: '#ffb6d9', primaryDark: '#ff8ec7', primaryLight: '#ffeff6', secondary: '#fff9b6', secondaryDark: '#ffeaa5', accent: '#d9cfff', accentDark: '#b8a3ff', text: '#6a4c6e', textLight: '#9b7a9f', bgMain: '#fff9fb', bgCard: 'rgba(255, 255, 255, 0.92)', gridLine: 'rgba(255, 182, 217, 0.15)' },
            blue: { primary: '#63b3ed', primaryDark: '#3182ce', primaryLight: '#ebf8ff', secondary: '#90cdf4', secondaryDark: '#4299e1', accent: '#9ae6b4', accentDark: '#68d391', text: '#2d3748', textLight: '#718096', bgMain: '#f7fafc', bgCard: 'rgba(255, 255, 255, 0.95)', gridLine: 'rgba(99, 179, 237, 0.15)' },
            yellow: { primary: '#f6e05e', primaryDark: '#d69e2e', primaryLight: '#fefcbf', secondary: '#faf089', secondaryDark: '#ecc94b', accent: '#9ae6b4', accentDark: '#68d391', text: '#744210', textLight: '#b7791f', bgMain: '#fffaf0', bgCard: 'rgba(255, 255, 255, 0.95)', gridLine: 'rgba(246, 224, 94, 0.15)' },
            green: { primary: '#68d391', primaryDark: '#38a169', primaryLight: '#c6f6d5', secondary: '#9ae6b4', secondaryDark: '#48bb78', accent: '#d6bcfa', accentDark: '#b794f4', text: '#22543d', textLight: '#38a169', bgMain: '#f0fff4', bgCard: 'rgba(255, 255, 255, 0.95)', gridLine: 'rgba(104, 211, 145, 0.15)' },
            dark: { primary: '#4fd1c7', primaryDark: '#319795', primaryLight: '#b2f5ea', secondary: '#81e6d9', secondaryDark: '#4fd1c7', accent: '#d6bcfa', accentDark: '#b794f4', text: '#e2e8f0', textLight: '#a0aec0', bgMain: '#1a202c', bgCard: 'rgba(45, 55, 72, 0.95)', gridLine: 'rgba(79, 209, 199, 0.15)' },
            gray: { primary: '#a0aec0', primaryDark: '#718096', primaryLight: '#edf2f7', secondary: '#cbd5e0', secondaryDark: '#a0aec0', accent: '#e2e8f0', accentDark: '#cbd5e0', text: '#4a5568', textLight: '#718096', bgMain: '#f7fafc', bgCard: 'rgba(255, 255, 255, 0.98)', gridLine: 'rgba(160, 174, 192, 0.15)' }
        };
        function applyTheme(themeName) {
            const theme = themes[themeName];
            const root = document.documentElement;
            root.style.setProperty('--color-primary', theme.primary);
            root.style.setProperty('--color-primary-dark', theme.primaryDark);
            root.style.setProperty('--color-primary-light', theme.primaryLight);
            root.style.setProperty('--color-secondary', theme.secondary);
            root.style.setProperty('--color-secondary-dark', theme.secondaryDark);
            root.style.setProperty('--color-accent', theme.accent);
            root.style.setProperty('--color-accent-dark', theme.accentDark);
            root.style.setProperty('--color-text', theme.text);
            root.style.setProperty('--color-text-light', theme.textLight);
            root.style.setProperty('--color-bg-main', theme.bgMain);
            root.style.setProperty('--color-bg-card', theme.bgCard);
            root.style.setProperty('--color-grid-line', theme.gridLine);
            userSettings.theme = themeName;
        }

        // ========== å¤´åƒä¸Šä¼  ==========
        document.getElementById('avatarContainer').addEventListener('click', () => { document.getElementById('avatarUpload').click(); });
        document.getElementById('avatarUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    userSettings.avatar = e.target.result;
                    document.getElementById('userAvatar').src = userSettings.avatar;
                    saveUserSettings();
                };
                reader.readAsDataURL(file);
            }
        });

        // ========== è®¾ç½®æ¨¡æ€æ¡†æ§åˆ¶ ==========
        document.getElementById('avatarContainer').addEventListener('click', (e) => {
            if (!e.target.closest('#avatarUpload')) {
                document.getElementById('settingsModal').style.display = 'flex';
            }
        });
        document.getElementById('closeSettingsBtn').addEventListener('click', () => {
            document.getElementById('settingsModal').style.display = 'none';
            applyUserSettings();
        });
        document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            userSettings.name = document.getElementById('inputUserName').value.trim() || 'æˆ‘';
            userSettings.age = document.getElementById('inputUserAge').value;
            userSettings.motto = document.getElementById('inputUserMotto').value.trim();
            saveUserSettings();
            applyUserSettings();
            document.getElementById('settingsModal').style.display = 'none';
            renderDiaries();
        });
        document.querySelectorAll('.theme-option').forEach(opt => {
            opt.addEventListener('click', function() {
                applyTheme(this.dataset.theme);
                document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // ========== å€’è®¡æ—¶ç®¡ç† ==========
        function renderCountdownList() {
            const listEl = document.getElementById('countdownList');
            listEl.innerHTML = '';
            userSettings.countdowns.forEach((cd, index) => {
                const li = document.createElement('li');
                li.className = 'countdown-item';
                const daysLeft = Math.ceil((new Date(cd.date) - now) / (1000*60*60*24));
                li.innerHTML = `<span><i class="far fa-calendar-alt"></i> ${cd.name} (${daysLeft}å¤©)</span><button class="btn-small btn-delete" data-index="${index}">åˆ é™¤</button>`;
                listEl.appendChild(li);
            });
            listEl.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    userSettings.countdowns.splice(index, 1);
                    saveUserSettings();
                    renderCountdownList();
                    renderDiaries();
                    updateGlobalCountdowns();
                });
            });
        }
        document.getElementById('addCountdownBtn').addEventListener('click', () => {
            const name = document.getElementById('inputCountdownName').value.trim();
            const date = document.getElementById('inputCountdownDate').value;
            if (!name || !date) { alert('è¯·å¡«å†™äº‹ä»¶åç§°å’Œæ—¥æœŸ'); return; }
            userSettings.countdowns.push({ name, date });
            document.getElementById('inputCountdownName').value = '';
            document.getElementById('inputCountdownDate').value = '';
            saveUserSettings();
            renderCountdownList();
            renderDiaries();
            updateGlobalCountdowns();
        });
        function updateGlobalCountdowns() {
            const container = document.getElementById('userCountdowns');
            if (userSettings.countdowns.length === 0) {
                container.innerHTML = '<div class="user-subtitle">ç‚¹å‡»å¤´åƒæ·»åŠ é‡è¦å€’è®¡æ—¶</div>';
                return;
            }
            let html = '<div style="display:flex; gap:15px; flex-wrap:wrap;">';
            userSettings.countdowns.forEach(cd => {
                const daysLeft = Math.ceil((new Date(cd.date) - now) / (1000*60*60*24));
                const color = daysLeft <= 30 ? '#ff6b6b' : daysLeft <= 90 ? '#ffa726' : '#4caf50';
                html += `<div style="background:${color}; color:white; padding:8px 15px; border-radius:10px; font-size:0.9rem;"><i class="far fa-clock"></i> ${cd.name}: <strong>${daysLeft}</strong>å¤©</div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // ========== æ ¸å¿ƒæ—¥è®°åŠŸèƒ½ ==========
        // 1. å¿ƒæƒ…é€‰æ‹©
        const moodOptions = document.querySelectorAll('.mood-option');
        moodOptions.forEach(option => {
            if (option.dataset.mood === 'neutral') option.classList.add('selected');
            option.addEventListener('click', function() {
                moodOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                selectedMood = this.dataset.mood;
            });
        });

        // 2. æ ‡ç­¾é€‰æ‹©ï¼ˆå¤šé€‰ï¼‰
        const tagOptions = document.querySelectorAll('.tag-option');
        tagOptions.forEach(option => {
            option.addEventListener('click', function() {
                const tag = this.dataset.tag;
                if (this.classList.contains('selected')) {
                    this.classList.remove('selected');
                    selectedTags = selectedTags.filter(t => t !== tag);
                } else {
                    this.classList.add('selected');
                    selectedTags.push(tag);
                }
            });
        });

        // 3. å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ
        const imageInput = document.getElementById('imageInput');
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imagePreview = document.getElementById('imagePreview');
        imageUploadArea.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageData = e.target.result;
                    imagePreview.src = imageData;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        // 4. ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ—¥è®°
        function loadDiaries() {
            const diaries = JSON.parse(localStorage.getItem('diaries')) || [];
            return diaries.sort((a, b) => new Date(b.date) - new Date(a.date));
        }

        // 5. ä¿å­˜æ—¥è®°åˆ°æœ¬åœ°å­˜å‚¨
        function saveDiary(diary) {
            const diaries = loadDiaries();
            const existingIndex = diaries.findIndex(d => d.date === diary.date);
            if (existingIndex !== -1) {
                if (confirm('åŒä¸€å¤©å·²å­˜åœ¨æ—¥è®°ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ')) {
                    diaries[existingIndex] = diary;
                } else {
                    return;
                }
            } else {
                diaries.push(diary);
            }
            localStorage.setItem('diaries', JSON.stringify(diaries));
            renderDiaries();
        }

        // 6. æ¸²æŸ“æ—¥è®°åˆ—è¡¨
        function renderDiaries(searchTerm = '') {
            const entriesContainer = document.getElementById('entriesContainer');
            const diaries = loadDiaries();
            const filteredDiaries = diaries.filter(diary =>
                diary.content.toLowerCase().includes(searchTerm.toLowerCase()) ||
                diary.date.includes(searchTerm) ||
                diary.food?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                diary.tags?.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()))
            );
            entriesContainer.innerHTML = '';
            if (filteredDiaries.length === 0) {
                entriesContainer.innerHTML = `<div class="no-entries"><div class="empty-icon"><i class="fas fa-journal-whills"></i></div><p>${searchTerm ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ—¥è®°' : 'è¿˜æ²¡æœ‰æ—¥è®°è®°å½•å“¦~'}</p><p>${searchTerm ? 'è¯•è¯•å…¶ä»–å…³é”®è¯å§ï¼' : 'å¿«å†™ä¸‹ç¬¬ä¸€ç¯‡æ—¥è®°å§ï¼'}</p></div>`;
                return;
            }
            filteredDiaries.forEach(diary => {
                const entryElement = document.createElement('div');
                entryElement.className = 'entry-item';
                const dateObj = new Date(diary.date);
                const formattedDate = dateObj.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                const tagsHtml = diary.tags && diary.tags.length > 0 ? `<div class="entry-tags">${diary.tags.map(tag => `<span class="entry-tag">${tag}</span>`).join('')}</div>` : '';
                const foodHtml = diary.food ? `<div class="entry-food"><strong>ğŸ½ï¸ ä»Šæ—¥é¥®é£Ÿï¼š</strong>${diary.food}</div>` : '';
                const imageHtml = diary.image ? `<img src="${diary.image}" class="entry-image" alt="æ—¥è®°é…å›¾">` : '';
                const countdownHtml = renderEntryCountdowns(diary.date);
                entryElement.innerHTML = `
                    <div class="entry-header">
                        <div class="entry-date">${formattedDate}</div>
                        <div class="entry-mood" title="${diary.mood}">${getMoodIcon(diary.mood)}</div>
                    </div>
                    ${countdownHtml}
                    ${tagsHtml}
                    ${foodHtml}
                    <div class="entry-content">${diary.content}</div>
                    ${imageHtml}
                    <div class="entry-footer">
                        <div class="entry-length">${diary.content.length} å­—</div>
                        <div class="entry-actions">
                            <button class="action-btn view-btn" data-date="${diary.date}"><i class="fas fa-edit"></i> ç¼–è¾‘</button>
                            <button class="action-btn delete-btn" data-date="${diary.date}"><i class="fas fa-trash"></i> åˆ é™¤</button>
                        </div>
                    </div>
                `;
                entriesContainer.appendChild(entryElement);
            });
            document.querySelectorAll('.view-btn').forEach(btn => { btn.addEventListener('click', () => viewDiary(btn.dataset.date)); });
            document.querySelectorAll('.delete-btn').forEach(btn => { btn.addEventListener('click', () => deleteDiary(btn.dataset.date)); });
        }

        // 7. æŸ¥çœ‹/ç¼–è¾‘æ—¥è®°
        function viewDiary(date) {
            const diaries = loadDiaries();
            const diary = diaries.find(d => d.date === date);
            if (!diary) return;
            document.getElementById('dateInput').value = diary.date;
            document.getElementById('foodInput').value = diary.food || '';
            document.getElementById('diaryText').value = diary.content;
            moodOptions.forEach(opt => opt.classList.remove('selected'));
            const moodOpt = document.querySelector(`.mood-option[data-mood="${diary.mood}"]`);
            if (moodOpt) moodOpt.classList.add('selected');
            selectedMood = diary.mood;
            tagOptions.forEach(opt => opt.classList.remove('selected'));
            selectedTags = [];
            if (diary.tags) {
                diary.tags.forEach(tag => {
                    const tagOpt = document.querySelector(`.tag-option[data-tag="${tag}"]`);
                    if (tagOpt) {
                        tagOpt.classList.add('selected');
                        selectedTags.push(tag);
                    }
                });
            }
            if (diary.image) {
                imageData = diary.image;
                imagePreview.src = imageData;
                imagePreview.style.display = 'block';
            } else {
                imageData = null;
                imagePreview.style.display = 'none';
            }
            document.querySelector('.editor-section').scrollIntoView({ behavior: 'smooth' });
        }

        // 8. åˆ é™¤æ—¥è®°
        function deleteDiary(date) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ')) {
                const diaries = loadDiaries();
                const filteredDiaries = diaries.filter(diary => diary.date !== date);
                localStorage.setItem('diaries', JSON.stringify(filteredDiaries));
                renderDiaries();
            }
        }

        // 9. å·¥å…·å‡½æ•°ï¼šè·å–å¿ƒæƒ…å›¾æ ‡
        function getMoodIcon(mood) {
            const icons = { 'happy':'ğŸ˜Š', 'neutral':'ğŸ˜Œ', 'sad':'ğŸ˜”', 'excited':'ğŸ¤©', 'tired':'ğŸ˜´', 'love':'ğŸ¥°' };
            return icons[mood] || 'ğŸ˜Œ';
        }

        // 10. å·¥å…·å‡½æ•°ï¼šæ¸²æŸ“æ—¥è®°å…³è”å€’è®¡æ—¶
        function renderEntryCountdowns(entryDate) {
            if (!userSettings.countdowns.length) return '';
            const entryDateObj = new Date(entryDate);
            let html = '<div class="entry-countdowns">';
            userSettings.countdowns.forEach(cd => {
                const targetDate = new Date(cd.date);
                const daysDiff = Math.ceil((targetDate - entryDateObj) / (1000*60*60*24));
                if (Math.abs(daysDiff) <= 365) {
                    const label = daysDiff > 0 ? `è·ç¦»${cd.name}è¿˜æœ‰${daysDiff}å¤©` : `${cd.name}å·²è¿‡å»${-daysDiff}å¤©`;
                    html += `<span class="countdown-badge"><i class="far fa-clock"></i> ${label}</span>`;
                }
            });
            html += '</div>';
            return html;
        }

        // ========== æ™ºèƒ½å¤‡ä»½å¯¼å…¥åŠŸèƒ½ ==========
        document.getElementById('importBtn').addEventListener('click', function() {
            const importText = document.getElementById('importTextarea').value.trim();
            if (!importText) { alert('è¯·ç²˜è´´å¤‡ä»½æ–‡æœ¬'); return; }
            if (!confirm('è¿™å°†è¦†ç›–ç°æœ‰æ—¥è®°ä¸­ç›¸åŒæ—¥æœŸçš„æ¡ç›®ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) return;
            const importedDiaries = parseBackupText(importText);
            if (importedDiaries.length === 0) { alert('æœªèƒ½ä»æ–‡æœ¬ä¸­è§£æå‡ºæœ‰æ•ˆçš„æ—¥è®°ã€‚è¯·æ£€æŸ¥æ ¼å¼ã€‚'); return; }
            const existingDiaries = loadDiaries();
            const dateMap = new Map();
            existingDiaries.forEach(d => dateMap.set(d.date, d));
            importedDiaries.forEach(newDiary => { dateMap.set(newDiary.date, newDiary); });
            const mergedDiaries = Array.from(dateMap.values());
            localStorage.setItem('diaries', JSON.stringify(mergedDiaries));
            alert(`æˆåŠŸå¯¼å…¥ ${importedDiaries.length} ç¯‡æ—¥è®°ï¼`);
            document.getElementById('importTextarea').value = '';
            renderDiaries();
        });
        function parseBackupText(text) {
            const diaries = [];
            const blocks = text.split(/ã€æ—¥è®° \d+ã€‘/);
            const moodMap = { 'ğŸ˜Š':'happy', 'ğŸ¥°':'love', 'ğŸ˜Œ':'neutral', 'ğŸ˜”':'sad', 'ğŸ˜´':'tired', 'ğŸ¤©':'excited' };
            blocks.forEach(block => {
                if (!block.trim()) return;
                const diary = { tags: [] };
                const dateMatch = block.match(/ğŸ“… æ—¥æœŸï¼š(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
                if (dateMatch) {
                    const [, year, month, day] = dateMatch;
                    diary.date = `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
                }
                const moodMatch = block.match(/ğŸ˜Š å¿ƒæƒ…ï¼š([ğŸ˜ŠğŸ¥°ğŸ˜ŒğŸ˜”ğŸ˜´ğŸ¤©]) (\w+)/);
                if (moodMatch) { diary.mood = moodMap[moodMatch[1]] || 'neutral'; }
                const tagsMatch = block.match(/ğŸ·ï¸ æ ‡ç­¾ï¼š(.+?)(?:\n|$)/);
                if (tagsMatch) { diary.tags = tagsMatch[1].split('ï¼Œ').map(t => t.trim()).filter(t => t); }
                const foodMatch = block.match(/ğŸ½ï¸ é¥®é£Ÿï¼š(.+?)(?:\n|$)/);
                if (foodMatch) { diary.food = foodMatch[1].trim(); }
                const contentMatch = block.match(/ğŸ“ æ­£æ–‡ï¼š\n([\s\S]+?)\n(?:\[æœ¬ç¯‡æ—¥è®°|------------------------------)/);
                if (contentMatch) { diary.content = contentMatch[1].trim(); }
                diary.image = null;
                diary.timestamp = new Date().toISOString();
                if (diary.date && diary.content) { diaries.push(diary); }
            });
            return diaries;
        }

        // ========== æœˆåº¦å¯¼å‡ºåŠŸèƒ½ ==========
        document.getElementById('exportBtn').addEventListener('click', function() {
            const monthValue = document.getElementById('monthSelect').value;
            if (!monthValue) { alert('è¯·å…ˆé€‰æ‹©æœˆä»½'); return; }
            const [year, month] = monthValue.split('-');
            const diaries = loadDiaries();
            const monthDiaries = diaries.filter(diary => {
                const diaryDate = new Date(diary.date);
                return diaryDate.getFullYear() == year && (diaryDate.getMonth() + 1) == month;
            });
            if (monthDiaries.length === 0) {
                document.getElementById('exportOutput').value = `ğŸ“… ${year}å¹´${month}æœˆ\n\nè¯¥æœˆä»½æ²¡æœ‰æ—¥è®°è®°å½•ã€‚`;
                return;
            }
            let exportText = `ğŸ“… ${year}å¹´${month}æœˆ æ—¥è®°å¤‡ä»½\n`;
            exportText += `ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}\n`;
            exportText += `å…±è®¡ ${monthDiaries.length} ç¯‡æ—¥è®°\n`;
            exportText += "=".repeat(40) + "\n\n";
            monthDiaries.forEach((diary, index) => {
                const dateObj = new Date(diary.date);
                const formattedDate = dateObj.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                exportText += `ã€æ—¥è®° ${index + 1}ã€‘\n`;
                exportText += `ğŸ“… æ—¥æœŸï¼š${formattedDate}\n`;
                exportText += `ğŸ˜Š å¿ƒæƒ…ï¼š${getMoodIcon(diary.mood)} ${diary.mood}\n`;
                if (diary.tags && diary.tags.length > 0) { exportText += `ğŸ·ï¸ æ ‡ç­¾ï¼š${diary.tags.join('ï¼Œ ')}\n`; }
                if (diary.food) { exportText += `ğŸ½ï¸ é¥®é£Ÿï¼š${diary.food}\n`; }
                exportText += `\nğŸ“ æ­£æ–‡ï¼š\n${diary.content}\n`;
                exportText += `\n${diary.image ? '[æœ¬ç¯‡æ—¥è®°åŒ…å«å›¾ç‰‡]' : '[æœ¬ç¯‡æ—¥è®°æ— å›¾ç‰‡]'}\n`;
                exportText += "-".repeat(30) + "\n\n";
            });
            exportText += `å¤‡ä»½æç¤ºï¼šæ­¤æ–‡æœ¬æ–‡ä»¶åŒ…å«${monthDiaries.length}ç¯‡æ—¥è®°çš„å®Œæ•´å†…å®¹ã€‚\nè¯·å¦¥å–„ä¿å­˜ï¼Œå¦‚éœ€é‡æ–°å¯¼å…¥ï¼Œå¯æ‰‹åŠ¨å¯¹ç…§å½•å…¥ã€‚`;
            document.getElementById('exportOutput').value = exportText;
        });

        // ========== ç»‘å®šæ ¸å¿ƒæŒ‰é’®äº‹ä»¶ ==========
        // ä¿å­˜æŒ‰é’®
        document.getElementById('saveBtn').addEventListener('click', function() {
            const date = document.getElementById('dateInput').value;
            const food = document.getElementById('foodInput').value.trim();
            const content = document.getElementById('diaryText').value.trim();
            if (!date) { alert('è¯·é€‰æ‹©æ—¥æœŸ'); return; }
            if (!content) { alert('è¯·å¡«å†™æ—¥è®°å†…å®¹'); return; }
            const diary = { date: date, mood: selectedMood, food: food, tags: [...selectedTags], content: content, image: imageData, timestamp: new Date().toISOString() };
            saveDiary(diary);
            // æ¸…ç©ºè¡¨å•
            document.getElementById('dateInput').valueAsDate = new Date();
            document.getElementById('foodInput').value = '';
            document.getElementById('diaryText').value = '';
            imageData = null;
            imagePreview.style.display = 'none';
            imageInput.value = '';
            moodOptions.forEach(opt => opt.classList.remove('selected'));
            document.querySelector('.mood-option[data-mood="neutral"]').classList.add('selected');
            selectedMood = 'neutral';
            tagOptions.forEach(opt => opt.classList.remove('selected'));
            selectedTags = [];
            alert('æ—¥è®°ä¿å­˜æˆåŠŸï¼âœ¨');
        });

        // æ¸…ç©ºæŒ‰é’®
        document.getElementById('clearBtn').addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰ç¼–è¾‘çš„å†…å®¹å—ï¼Ÿ')) {
                document.getElementById('dateInput').valueAsDate = new Date();
                document.getElementById('foodInput').value = '';
                document.getElementById('diaryText').value = '';
                imageData = null;
                imagePreview.style.display = 'none';
                imageInput.value = '';
                moodOptions.forEach(opt => opt.classList.remove('selected'));
                document.querySelector('.mood-option[data-mood="neutral"]').classList.add('selected');
                selectedMood = 'neutral';
                tagOptions.forEach(opt => opt.classList.remove('selected'));
                selectedTags = [];
            }
        });

        // æœç´¢åŠŸèƒ½
        document.getElementById('searchInput').addEventListener('input', function() {
            renderDiaries(this.value);
        });

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        loadUserSettings();
        renderDiaries();
        console.log('æ—¥è®°æœ¬é«˜çº§ç‰ˆå·²åŠ è½½ï¼Œäº«å—ä½ çš„ä¸ªæ€§åŒ–æ—¥è®°ä½“éªŒï¼');
    </script>
</body>
</html>