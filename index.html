<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è‹¹æœéª‘å£«ï¼šæ‰‹æœºæ¨ªç‰ˆå¤§å†’é™©</title>
    <style>
        /* å…¨å±€é‡ç½®ä¸åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(to bottom, #1a5f7a, #0a2647);
            color: #fff;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* æ¸¸æˆæ ‡é¢˜ */
        .game-title {
            position: absolute;
            top: 10px;
            text-align: center;
            width: 100%;
            z-index: 100;
        }

        h1 {
            font-size: 2.2rem;
            color: #FFD700;
            text-shadow: 0 3px 0 #8B4513, 0 5px 10px rgba(0,0,0,0.7);
            margin-bottom: 5px;
        }

        .subtitle {
            font-size: 1rem;
            color: #87CEEB;
        }

        /* æ¸¸æˆä¸»ç”»å¸ƒå®¹å™¨ */
        #gameContainer {
            position: relative;
            width: 100%;
            height: 65vh;
            max-width: 500px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 4px solid #FFA500;
            background: #87CEEB;
            margin-top: 20px;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #87CEEB 0%, #98FB98 100%);
        }

        /* è™šæ‹Ÿæ§åˆ¶å±‚ */
        #controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 35vh;
            pointer-events: none;
            z-index: 50;
        }

        /* å·¦ä¾§è™šæ‹Ÿæ‘‡æ† */
        #joystickContainer {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 120px;
            height: 120px;
            pointer-events: auto;
        }

        #joystickBase {
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.6);
        }

        #joystickHandle {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 2px solid #FFA500;
        }

        /* å³ä¾§åŠ¨ä½œæŒ‰é’® */
        #actionButtons {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 20px;
            pointer-events: auto;
        }

        .action-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.4), 0 8px 15px rgba(0, 0, 0, 0.4);
            transition: all 0.1s;
            -webkit-tap-highlight-color: transparent;
            position: relative;
        }

        .action-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.4), 0 4px 8px rgba(0, 0, 0, 0.4);
        }

        #jumpBtn {
            background: linear-gradient(to bottom, #4CAF50, #2E7D32);
            border: 3px solid #A5D6A7;
        }

        #attackBtn {
            background: linear-gradient(to bottom, #F44336, #C62828);
            border: 3px solid #FFAB91;
        }

        #bombBtn {
            background: linear-gradient(to bottom, #FF9800, #EF6C00);
            border: 3px solid #FFCC80;
            grid-column: span 2;
            width: 180px;
            border-radius: 40px;
            font-size: 1.5rem;
        }

        .btn-label {
            position: absolute;
            bottom: -25px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 2px black;
            width: 100%;
            text-align: center;
        }

        /* æ¸¸æˆçŠ¶æ€é¢æ¿ */
        #hud {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            z-index: 100;
            pointer-events: none;
        }

        .hud-item {
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }

        .hud-item span {
            margin-left: 8px;
            font-weight: bold;
            color: #FFD700;
        }

        /* æ¸¸æˆå¼€å§‹/ç»“æŸç•Œé¢ */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            text-align: center;
            padding: 20px;
        }

        .screen h2 {
            font-size: 3rem;
            color: #FFD700;
            margin-bottom: 20px;
            text-shadow: 0 3px 0 #8B4513;
        }

        .screen p {
            font-size: 1.3rem;
            margin-bottom: 30px;
            max-width: 80%;
            line-height: 1.5;
            color: #E0E0E0;
        }

        #startScreen {
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.9), rgba(56, 142, 60, 0.9));
        }

        .btn {
            background: linear-gradient(to bottom, #FF6B6B, #C2185B);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 0 #8B0000, 0 15px 25px rgba(0, 0, 0, 0.5);
            transition: all 0.2s;
        }

        .btn:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #8B0000, 0 5px 10px rgba(0, 0, 0, 0.5);
        }

        /* æ“ä½œæç¤º */
        #mobileTips {
            position: absolute;
            bottom: 160px;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            padding: 0 20px;
            z-index: 40;
        }
    </style>
</head>
<body>
    <div class="game-title">
        <h1>ğŸ è‹¹æœéª‘å£« ğŸ</h1>
        <div class="subtitle">æ¨ªç‰ˆåŠ¨ä½œå†’é™© - æ‰‹æœºè§¦æ§ç‰ˆ</div>
    </div>

    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <!-- æ¸¸æˆçŠ¶æ€æ˜¾ç¤º -->
        <div id="hud">
            <div class="hud-item">â¤ï¸ <span id="healthValue">100</span></div>
            <div class="hud-item">â­ <span id="scoreValue">0</span></div>
            <div class="hud-item">ğŸ’£ <span id="bombValue">3</span></div>
        </div>
        
        <!-- æ¸¸æˆå¼€å§‹ç•Œé¢ -->
        <div id="startScreen" class="screen">
            <h2>è‹¹æœéª‘å£«å¤§å†’é™©</h2>
            <p>é‚ªæ¶çš„è…çƒ‚æ°´æœå†›å›¢ç»‘æ¶äº†å›½ç‹ï¼<br>ä½¿ç”¨è™šæ‹Ÿæ‘‡æ†ç§»åŠ¨ï¼ŒæŒ‰é’®è·³è·ƒå’Œæ”»å‡»ã€‚<br>ç©¿è¶Šå±é™©æ£®æ—ï¼Œå‡»è´¥æ‰€æœ‰æ€ªç‰©ï¼</p>
            <button id="startBtn" class="btn">å¼€å§‹æ¸¸æˆ</button>
            <p style="margin-top: 20px; font-size: 1rem; color: #FFCC80;">æç¤ºï¼šæ‘‡æ†æ§åˆ¶ç§»åŠ¨ï¼Œå³ä¾§æŒ‰é’®è·³è·ƒ/æ”»å‡»</p>
        </div>
        
        <!-- æ¸¸æˆç»“æŸç•Œé¢ï¼ˆé»˜è®¤éšè—ï¼‰ -->
        <div id="gameOverScreen" class="screen" style="display: none;">
            <h2>æ¸¸æˆç»“æŸ</h2>
            <p>è‹¹æœéª‘å£«è¢«å‡»è´¥äº†...<br>ä½ çš„å¾—åˆ†ï¼š<span id="finalScore">0</span></p>
            <button id="restartBtn" class="btn">é‡æ–°å¼€å§‹</button>
        </div>
    </div>
    
    <!-- è™šæ‹Ÿæ§åˆ¶å±‚ -->
    <div id="controls">
        <div id="joystickContainer">
            <div id="joystickBase"></div>
            <div id="joystickHandle"></div>
        </div>
        
        <div id="actionButtons">
            <button id="jumpBtn" class="action-btn">
                â¬†ï¸
                <div class="btn-label">è·³è·ƒ</div>
            </button>
            <button id="attackBtn" class="action-btn">
                âš”ï¸
                <div class="btn-label">æ”»å‡»</div>
            </button>
            <button id="bombBtn" class="action-btn">
                ğŸ’£ è‹¹æœç‚¸å¼¹
                <div class="btn-label">æŠ€èƒ½</div>
            </button>
        </div>
        
        <div id="mobileTips">
            ä½¿ç”¨å·¦ä¾§æ‘‡æ†ç§»åŠ¨ï¼Œå³ä¾§æŒ‰é’®æ‰§è¡ŒåŠ¨ä½œ
        </div>
    </div>

    <script>
        // ==================== æ¸¸æˆæ ¸å¿ƒé…ç½® ====================
        const config = {
            gravity: 0.8,
            playerSpeed: 6,
            jumpForce: -16,
            worldWidth: 2000,
            cameraSmooth: 0.1
        };

        // ==================== æ¸¸æˆçŠ¶æ€ ====================
        const gameState = {
            player: {
                x: 300,
                y: 300,
                width: 60,
                height: 80,
                velocityX: 0,
                velocityY: 0,
                isOnGround: false,
                facingRight: true,
                isAttacking: false,
                attackTimer: 0,
                health: 100,
                maxHealth: 100,
                bombs: 3,
                score: 0,
                // åŠ¨ç”»çŠ¶æ€
                state: 'idle', // idle, running, jumping, attacking
                frame: 0,
                frameTimer: 0
            },
            
            joystick: {
                active: false,
                x: 0,
                y: 0,
                baseX: 0,
                baseY: 0,
                maxDistance: 50
            },
            
            keys: {
                left: false,
                right: false,
                up: false,
                attack: false
            },
            
            camera: {
                x: 0,
                y: 0
            },
            
            gameRunning: false,
            gameOver: false,
            
            platforms: [
                // åœ°é¢
                {x: 0, y: 450, width: 400, height: 50},
                {x: 450, y: 420, width: 200, height: 30},
                {x: 700, y: 380, width: 150, height: 30},
                {x: 900, y: 350, width: 200, height: 30},
                {x: 1200, y: 320, width: 250, height: 30},
                {x: 1550, y: 280, width: 300, height: 40},
                // æµ®ç©ºå¹³å°
                {x: 300, y: 350, width: 100, height: 20},
                {x: 600, y: 300, width: 80, height: 20},
                {x: 850, y: 250, width: 100, height: 20},
                {x: 1100, y: 220, width: 120, height: 20},
                {x: 1400, y: 200, width: 100, height: 20}
            ],
            
            monsters: [
                {x: 500, y: 370, width: 50, height: 60, type: 'strawberry', health: 30, speed: 1.5},
                {x: 800, y: 330, width: 60, height: 70, type: 'pineapple', health: 50, speed: 1},
                {x: 1050, y: 170, width: 55, height: 65, type: 'grape', health: 40, speed: 2},
                {x: 1350, y: 150, width: 70, height: 80, type: 'watermelon', health: 80, speed: 0.8}
            ],
            
            particles: []
        };

        // ==================== DOMå…ƒç´  ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('startScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');
        const healthValue = document.getElementById('healthValue');
        const scoreValue = document.getElementById('scoreValue');
        const bombValue = document.getElementById('bombValue');
        const finalScore = document.getElementById('finalScore');
        
        const joystickContainer = document.getElementById('joystickContainer');
        const joystickHandle = document.getElementById('joystickHandle');
        const jumpBtn = document.getElementById('jumpBtn');
        const attackBtn = document.getElementById('attackBtn');
        const bombBtn = document.getElementById('bombBtn');

        // ==================== åˆå§‹åŒ– ====================
        function init() {
            // è®¾ç½®ç”»å¸ƒå¤§å°
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // æ¸¸æˆå¼€å§‹æŒ‰é’®
            startBtn.addEventListener('click', startGame);
            restartBtn.addEventListener('click', startGame);
            
            // è™šæ‹Ÿæ‘‡æ†äº‹ä»¶
            initJoystick();
            
            // åŠ¨ä½œæŒ‰é’®äº‹ä»¶
            initActionButtons();
            
            // å¼€å§‹æ¸¸æˆå¾ªç¯
            requestAnimationFrame(gameLoop);
        }

        // ==================== è™šæ‹Ÿæ‘‡æ†å®ç° ====================
        function initJoystick() {
            let isTouching = false;
            
            // è§¦æ‘¸å¼€å§‹
            joystickContainer.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isTouching = true;
                const rect = joystickContainer.getBoundingClientRect();
                gameState.joystick.baseX = rect.left + rect.width / 2;
                gameState.joystick.baseY = rect.top + rect.height / 2;
                updateJoystick(e.touches[0]);
            });
            
            // è§¦æ‘¸ç§»åŠ¨
            document.addEventListener('touchmove', (e) => {
                if (!isTouching) return;
                e.preventDefault();
                updateJoystick(e.touches[0]);
            });
            
            // è§¦æ‘¸ç»“æŸ
            document.addEventListener('touchend', (e) => {
                if (!isTouching) return;
                isTouching = false;
                resetJoystick();
            });
            
            // é¼ æ ‡æ”¯æŒï¼ˆå¼€å‘æµ‹è¯•ç”¨ï¼‰
            joystickContainer.addEventListener('mousedown', (e) => {
                isTouching = true;
                gameState.joystick.baseX = joystickContainer.offsetLeft + joystickContainer.offsetWidth / 2;
                gameState.joystick.baseY = joystickContainer.offsetTop + joystickContainer.offsetHeight / 2;
                updateJoystick(e);
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
            
            function onMouseMove(e) {
                if (!isTouching) return;
                updateJoystick(e);
            }
            
            function onMouseUp() {
                isTouching = false;
                resetJoystick();
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        }
        
        function updateJoystick(touch) {
            const touchX = touch.clientX;
            const touchY = touch.clientY;
            
            let deltaX = touchX - gameState.joystick.baseX;
            let deltaY = touchY - gameState.joystick.baseY;
            
            // é™åˆ¶æ‘‡æ†ç§»åŠ¨èŒƒå›´
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            if (distance > gameState.joystick.maxDistance) {
                deltaX = (deltaX / distance) * gameState.joystick.maxDistance;
                deltaY = (deltaY / distance) * gameState.joystick.maxDistance;
            }
            
            // æ›´æ–°æ‘‡æ†æ‰‹æŸ„ä½ç½®
            joystickHandle.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
            
            // æ›´æ–°æ¸¸æˆæ§åˆ¶çŠ¶æ€
            gameState.joystick.active = true;
            gameState.joystick.x = deltaX / gameState.joystick.maxDistance; // æ ‡å‡†åŒ–åˆ°-1åˆ°1
            gameState.joystick.y = deltaY / gameState.joystick.maxDistance;
            
            // è®¾ç½®é”®ç›˜çŠ¶æ€ï¼ˆå…¼å®¹åŸæœ‰é€»è¾‘ï¼‰
            gameState.keys.left = gameState.joystick.x < -0.3;
            gameState.keys.right = gameState.joystick.x > 0.3;
        }
        
        function resetJoystick() {
            joystickHandle.style.transform = 'translate(-50%, -50%)';
            gameState.joystick.active = false;
            gameState.joystick.x = 0;
            gameState.joystick.y = 0;
            gameState.keys.left = false;
            gameState.keys.right = false;
        }

        // ==================== åŠ¨ä½œæŒ‰é’®å®ç° ====================
        function initActionButtons() {
            // è·³è·ƒæŒ‰é’®
            jumpBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.keys.up = true;
                jumpBtn.style.transform = 'translateY(4px)';
                jumpBtn.style.boxShadow = '0 2px 0 rgba(0, 0, 0, 0.4), 0 4px 8px rgba(0, 0, 0, 0.4)';
            });
            
            jumpBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                gameState.keys.up = false;
                jumpBtn.style.transform = 'translateY(0)';
                jumpBtn.style.boxShadow = '0 6px 0 rgba(0, 0, 0, 0.4), 0 8px 15px rgba(0, 0, 0, 0.4)';
            });
            
            // æ”»å‡»æŒ‰é’®
            attackBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.keys.attack = true;
                attackBtn.style.transform = 'translateY(4px)';
                attackBtn.style.boxShadow = '0 2px 0 rgba(0, 0, 0, 0.4), 0 4px 8px rgba(0, 0, 0, 0.4)';
            });
            
            attackBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                gameState.keys.attack = false;
                attackBtn.style.transform = 'translateY(0)';
                attackBtn.style.boxShadow = '0 6px 0 rgba(0, 0, 0, 0.4), 0 8px 15px rgba(0, 0, 0, 0.4)';
            });
            
            // ç‚¸å¼¹æŒ‰é’®
            bombBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                useBomb();
                bombBtn.style.transform = 'translateY(4px)';
                bombBtn.style.boxShadow = '0 2px 0 rgba(0, 0, 0, 0.4), 0 4px 8px rgba(0, 0, 0, 0.4)';
            });
            
            bombBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                bombBtn.style.transform = 'translateY(0)';
                bombBtn.style.boxShadow = '0 6px 0 rgba(0, 0, 0, 0.4), 0 8px 15px rgba(0, 0, 0, 0.4)';
            });
        }

        // ==================== æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ====================
        function startGame() {
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.player = {
                x: 300,
                y: 300,
                width: 60,
                height: 80,
                velocityX: 0,
                velocityY: 0,
                isOnGround: false,
                facingRight: true,
                isAttacking: false,
                attackTimer: 0,
                health: 100,
                maxHealth: 100,
                bombs: 3,
                score: 0,
                state: 'idle',
                frame: 0,
                frameTimer: 0
            };
            
            gameState.camera = {x: 0, y: 0};
            gameState.gameRunning = true;
            gameState.gameOver = false;
            
            // é‡ç½®æ€ªç‰©
            gameState.monsters = [
                {x: 500, y: 370, width: 50, height: 60, type: 'strawberry', health: 30, speed: 1.5},
                {x: 800, y: 330, width: 60, height: 70, type: 'pineapple', health: 50, speed: 1},
                {x: 1050, y: 170, width: 55, height: 65, type: 'grape', health: 40, speed: 2},
                {x: 1350, y: 150, width: 70, height: 80, type: 'watermelon', health: 80, speed: 0.8}
            ];
            
            // éšè—ç•Œé¢
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            
            // æ›´æ–°HUD
            updateHUD();
        }
        
        function gameLoop() {
            if (gameState.gameRunning) {
                update();
                render();
            }
            requestAnimationFrame(gameLoop);
        }
        
        function update() {
            const player = gameState.player;
            
            // 1. å¤„ç†ç©å®¶è¾“å…¥
            let moveDirection = 0;
            if (gameState.keys.left) moveDirection -= 1;
            if (gameState.keys.right) moveDirection += 1;
            
            player.velocityX = moveDirection * config.playerSpeed;
            
            // è®¾ç½®ç©å®¶çŠ¶æ€
            if (moveDirection !== 0) {
                player.facingRight = moveDirection > 0;
                if (player.isOnGround) {
                    player.state = 'running';
                }
            } else if (player.isOnGround) {
                player.state = 'idle';
            }
            
            // è·³è·ƒ
            if (gameState.keys.up && player.isOnGround) {
                player.velocityY = config.jumpForce;
                player.isOnGround = false;
                player.state = 'jumping';
                createParticles(player.x + player.width/2, player.y + player.height, 5, '#FFD700');
            }
            
            // æ”»å‡»
            if (gameState.keys.attack && player.attackTimer <= 0) {
                player.isAttacking = true;
                player.attackTimer = 15; // æ”»å‡»æŒç»­æ—¶é—´
                player.state = 'attacking';
                performAttack();
            }
            
            // æ›´æ–°æ”»å‡»è®¡æ—¶å™¨
            if (player.attackTimer > 0) {
                player.attackTimer--;
                if (player.attackTimer <= 0) {
                    player.isAttacking = false;
                }
            }
            
            // 2. åº”ç”¨ç‰©ç†
            player.velocityY += config.gravity;
            player.x += player.velocityX;
            player.y += player.velocityY;
            
            // 3. ç¢°æ’æ£€æµ‹ï¼ˆä¸å¹³å°ï¼‰
            player.isOnGround = false;
            for (const platform of gameState.platforms) {
                if (player.x < platform.x + platform.width &&
                    player.x + player.width > platform.x &&
                    player.y < platform.y + platform.height &&
                    player.y + player.height > platform.y) {
                    
                    // ä»ä¸Šæ–¹è½åœ°
                    if (player.velocityY > 0 && player.y + player.height - player.velocityY <= platform.y) {
                        player.y = platform.y - player.height;
                        player.velocityY = 0;
                        player.isOnGround = true;
                    }
                    // ç¢°åˆ°å¤´é¡¶
                    else if (player.velocityY < 0) {
                        player.y = platform.y + platform.height;
                        player.velocityY = 0;
                    }
                    // å·¦å³ç¢°æ’
                    else if (player.velocityX !== 0) {
                        if (player.x < platform.x + platform.width && player.x + player.width > platform.x + platform.width) {
                            player.x = platform.x + platform.width;
                        } else {
                            player.x = platform.x - player.width;
                        }
                        player.velocityX = 0;
                    }
                }
            }
            
            // è¾¹ç•Œæ£€æµ‹
            if (player.y > canvas.height) {
                player.health = 0;
            }
            
            if (player.health <= 0) {
                endGame(false);
            }
            
            // 4. æ›´æ–°æ€ªç‰©
            for (let i = gameState.monsters.length - 1; i >= 0; i--) {
                const monster = gameState.monsters[i];
                
                // ç®€å•AIï¼šæ¥å›ç§»åŠ¨
                monster.x += monster.speed;
                
                // å¹³å°è¾¹ç•Œæ£€æµ‹
                let onPlatform = false;
                for (const platform of gameState.platforms) {
                    if (monster.x >= platform.x && monster.x + monster.width <= platform.x + platform.width &&
                        Math.abs(monster.y + monster.height - platform.y) < 5) {
                        onPlatform = true;
                        break;
                    }
                }
                
                // å¦‚æœä¸åœ¨å¹³å°ä¸Šæˆ–åˆ°è¾¾è¾¹ç¼˜ï¼Œè½¬å‘
                if (!onPlatform || monster.x <= 0 || monster.x + monster.width >= config.worldWidth) {
                    monster.speed *= -1;
                }
                
                // æ€ªç‰©ä¸ç©å®¶ç¢°æ’
                if (!player.isAttacking && 
                    player.x < monster.x + monster.width &&
                    player.x + player.width > monster.x &&
                    player.y < monster.y + monster.height &&
                    player.y + player.height > monster.y) {
                    
                    player.health -= 10;
                    updateHUD();
                    // å‡»é€€æ•ˆæœ
                    player.velocityX = monster.x > player.x ? -10 : 10;
                    player.velocityY = -8;
                }
                
                // æ€ªç‰©æ­»äº¡
                if (monster.health <= 0) {
                    createParticles(monster.x + monster.width/2, monster.y + monster.height/2, 15, monster.type === 'strawberry' ? '#FF6B6B' : '#4CAF50');
                    gameState.player.score += 100;
                    gameState.monsters.splice(i, 1);
                    updateHUD();
                }
            }
            
            // 5. æ›´æ–°ç²’å­
            for (let i = gameState.particles.length - 1; i >= 0; i--) {
                const particle = gameState.particles[i];
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.vy += 0.2; // é‡åŠ›
                particle.life--;
                
                if (particle.life <= 0) {
                    gameState.particles.splice(i, 1);
                }
            }
            
            // 6. æ›´æ–°ç›¸æœºï¼ˆè·Ÿéšç©å®¶ï¼‰
            const targetCameraX = player.x - canvas.width / 3;
            gameState.camera.x += (targetCameraX - gameState.camera.x) * config.cameraSmooth;
            
            // é™åˆ¶ç›¸æœºèŒƒå›´
            gameState.camera.x = Math.max(0, Math.min(gameState.camera.x, config.worldWidth - canvas.width));
            
            // 7. æ£€æŸ¥æ¸¸æˆèƒœåˆ©
            if (gameState.monsters.length === 0) {
                endGame(true);
            }
        }
        
        function performAttack() {
            const player = gameState.player;
            const attackRange = 80;
            const attackWidth = 40;
            
            const attackX = player.facingRight ? player.x + player.width : player.x - attackWidth;
            const attackY = player.y + player.height / 3;
            
            // æ£€æµ‹æ”»å‡»å‘½ä¸­çš„æ€ªç‰©
            for (const monster of gameState.monsters) {
                if (attackX < monster.x + monster.width &&
                    attackX + attackWidth > monster.x &&
                    attackY < monster.y + monster.height &&
                    attackY + attackWidth > monster.y) {
                    
                    monster.health -= 25;
                    createParticles(monster.x + monster.width/2, monster.y + monster.height/2, 8, '#FFD700');
                    
                    // å‡»é€€æ•ˆæœ
                    monster.x += player.facingRight ? 20 : -20;
                }
            }
            
            // æ”»å‡»ç‰¹æ•ˆç²’å­
            for (let i = 0; i < 5; i++) {
                gameState.particles.push({
                    x: player.facingRight ? player.x + player.width : player.x,
                    y: player.y + player.height / 2,
                    vx: (player.facingRight ? 5 : -5) + (Math.random() * 4 - 2),
                    vy: Math.random() * 4 - 2,
                    size: Math.random() * 6 + 3,
                    color: '#FFD700',
                    life: 20
                });
            }
        }
        
        function useBomb() {
            if (gameState.player.bombs <= 0) return;
            
            gameState.player.bombs--;
            updateHUD();
            
            const player = gameState.player;
            const bombRadius = 100;
            
            // ç‚¸å¼¹ç‰¹æ•ˆ
            for (let i = 0; i < 30; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 8 + 2;
                gameState.particles.push({
                    x: player.x + player.width / 2,
                    y: player.y + player.height / 2,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    size: Math.random() * 8 + 4,
                    color: '#FF9800',
                    life: 40
                });
            }
            
            // ä¼¤å®³èŒƒå›´å†…çš„æ€ªç‰©
            for (const monster of gameState.monsters) {
                const dx = (monster.x + monster.width/2) - (player.x + player.width/2);
                const dy = (monster.y + monster.height/2) - (player.y + player.height/2);
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < bombRadius) {
                    monster.health = 0;
                    gameState.player.score += 150;
                }
            }
            
            updateHUD();
        }
        
        function createParticles(x, y, count, color) {
            for (let i = 0; i < count; i++) {
                gameState.particles.push({
                    x: x,
                    y: y,
                    vx: Math.random() * 8 - 4,
                    vy: Math.random() * -6 - 2,
                    size: Math.random() * 6 + 2,
                    color: color,
                    life: Math.random() * 30 + 20
                });
            }
        }
        
        function endGame(victory) {
            gameState.gameRunning = false;
            gameState.gameOver = true;
            
            finalScore.textContent = gameState.player.score;
            
            if (victory) {
                gameOverScreen.querySelector('h2').textContent = 'èƒœåˆ©ï¼';
                gameOverScreen.querySelector('p').innerHTML = `ä½ å‡»è´¥äº†æ‰€æœ‰æ€ªç‰©ï¼<br>ä½ çš„å¾—åˆ†ï¼š<span id="finalScore">${gameState.player.score}</span>`;
            }
            
            gameOverScreen.style.display = 'flex';
        }
        
        function updateHUD() {
            healthValue.textContent = gameState.player.health;
            scoreValue.textContent = gameState.player.score;
            bombValue.textContent = gameState.player.bombs;
        }

        // ==================== æ¸²æŸ“å‡½æ•° ====================
        function render() {
            const ctx = canvas.getContext('2d');
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ä¿å­˜å½“å‰ç”»å¸ƒçŠ¶æ€
            ctx.save();
            
            // åº”ç”¨ç›¸æœºå˜æ¢
            ctx.translate(-gameState.camera.x, -gameState.camera.y);
            
            // 1. ç»˜åˆ¶èƒŒæ™¯
            drawBackground();
            
            // 2. ç»˜åˆ¶å¹³å°
            ctx.fillStyle = '#8B4513';
            for (const platform of gameState.platforms) {
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                
                // å¹³å°é¡¶éƒ¨çº¹ç†
                ctx.fillStyle = '#A0522D';
                ctx.fillRect(platform.x, platform.y, platform.width, 5);
                ctx.fillStyle = '#8B4513';
            }
            
            // 3. ç»˜åˆ¶æ€ªç‰©
            for (const monster of gameState.monsters) {
                drawMonster(monster);
            }
            
            // 4. ç»˜åˆ¶ç©å®¶ï¼ˆè‹¹æœéª‘å£«ï¼‰
            drawPlayer();
            
            // 5. ç»˜åˆ¶ç²’å­
            for (const particle of gameState.particles) {
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // æ¢å¤ç”»å¸ƒçŠ¶æ€
            ctx.restore();
            
            // 6. ç»˜åˆ¶æ”»å‡»èŒƒå›´ï¼ˆè°ƒè¯•ç”¨ï¼Œå¯é€‰ï¼‰
            if (gameState.player.isAttacking) {
                const player = gameState.player;
                const attackRange = 80;
                const attackWidth = 40;
                const attackX = player.facingRight ? player.x + player.width : player.x - attackWidth;
                const attackY = player.y + player.height / 3;
                
                ctx.fillStyle = 'rgba(255, 215, 0, 0.3)';
                ctx.fillRect(attackX - gameState.camera.x, attackY, attackWidth, attackWidth);
            }
        }
        
        function drawBackground() {
            const ctx = canvas.getContext('2d');
            
            // å¤©ç©ºæ¸å˜
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#98FB98');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, config.worldWidth, canvas.height);
            
            // è¿œå¤„çš„å±±
            for (let i = 0; i < 5; i++) {
                const x = (i * 400) % config.worldWidth;
                const height = 100 + Math.sin(i) * 30;
                ctx.fillStyle = '#2E8B57';
                ctx.beginPath();
                ctx.moveTo(x, canvas.height - 100);
                ctx.bezierCurveTo(x + 100, canvas.height - 100 - height, 
                                x + 200, canvas.height - 100 - height/2, 
                                x + 300, canvas.height - 100);
                ctx.closePath();
                ctx.fill();
            }
            
            // äº‘æœµ
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            for (let i = 0; i < 8; i++) {
                const x = (i * 350 + gameState.camera.x * 0.3) % config.worldWidth;
                const y = 80 + Math.sin(i) * 30;
                const size = 40;
                
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.arc(x + size * 0.8, y - size * 0.2, size * 0.7, 0, Math.PI * 2);
                ctx.arc(x + size * 0.8, y + size * 0.2, size * 0.7, 0, Math.PI * 2);
                ctx.arc(x - size * 0.8, y, size * 0.7, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        function drawPlayer() {
            const player = gameState.player;
            const ctx = canvas.getContext('2d');
            
            // ä¿å­˜ç”»å¸ƒçŠ¶æ€
            ctx.save();
            
            // è®¾ç½®ç»˜åˆ¶åŸç‚¹ä¸ºç©å®¶ä¸­å¿ƒ
            ctx.translate(player.x + player.width/2, player.y + player.height/2);
            
            // å¦‚æœé¢æœå·¦ï¼Œæ°´å¹³ç¿»è½¬
            if (!player.facingRight) {
                ctx.scale(-1, 1);
            }
            
            // ===== ç»˜åˆ¶è‹¹æœéª‘å£« =====
            
            // èº«ä½“ï¼ˆè‹¹æœå½¢çŠ¶ï¼‰
            ctx.fillStyle = '#FF6B6B';
            ctx.beginPath();
            ctx.ellipse(0, -10, player.width/2.5, player.height/3, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // è‹¹æœèŒ
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(-2, -player.height/3 + 5, 4, 12);
            
            // å¶å­
            ctx.fillStyle = '#228B22';
            ctx.beginPath();
            ctx.ellipse(5, -player.height/3 + 10, 6, 4, Math.PI/4, 0, Math.PI * 2);
            ctx.fill();
            
            // çœ¼ç›
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(-10, -20, 6, 0, Math.PI * 2);
            ctx.arc(10, -20, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // ç³å­”ï¼ˆæ ¹æ®ç§»åŠ¨æ–¹å‘æœ‰è¡¨æƒ…ï¼‰
            ctx.fillStyle = '#333';
            ctx.beginPath();
            if (player.state === 'running') {
                // è·‘æ­¥æ—¶çœ¼ç›æ›´ä¸“æ³¨
                ctx.arc(-8, -20, 3, 0, Math.PI * 2);
                ctx.arc(8, -20, 3, 0, Math.PI * 2);
            } else {
                ctx.arc(-10, -20, 3, 0, Math.PI * 2);
                ctx.arc(10, -20, 3, 0, Math.PI * 2);
            }
            ctx.fill();
            
            // å˜´å·´ï¼ˆä¸åŒçŠ¶æ€ä¸åŒè¡¨æƒ…ï¼‰
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            if (player.isAttacking) {
                // æ”»å‡»æ—¶å¼ å˜´
                ctx.arc(0, -10, 8, 0.1 * Math.PI, 0.9 * Math.PI);
            } else if (player.state === 'jumping') {
                // è·³è·ƒæ—¶å¾®ç¬‘
                ctx.arc(0, -8, 8, 0.3 * Math.PI, 0.7 * Math.PI);
            } else {
                // å¹³å¸¸è¡¨æƒ…
                ctx.arc(0, -10, 8, 0.2 * Math.PI, 0.8 * Math.PI);
            }
            ctx.stroke();
            
            // æŠ«é£
            ctx.fillStyle = '#4A148C';
            ctx.beginPath();
            ctx.moveTo(-player.width/3, 0);
            ctx.bezierCurveTo(-player.width/2, 10, 
                            0, player.height/3, 
                            player.width/3, 0);
            ctx.bezierCurveTo(0, player.height/4, 
                            -player.width/4, 5, 
                            -player.width/3, 0);
            ctx.fill();
            
            // å‰‘ï¼ˆæ”»å‡»æ—¶ç»˜åˆ¶ï¼‰
            if (player.isAttacking) {
                ctx.fillStyle = '#C0C0C0';
                ctx.fillRect(player.width/4, -15, 40, 6);
                ctx.fillRect(player.width/4 + 40, -25, 6, 20);
                
                // å‰‘å…‰ç‰¹æ•ˆ
                ctx.fillStyle = 'rgba(255, 255, 200, 0.7)';
                ctx.fillRect(player.width/4 + 45, -30, 10, 30);
            }
            
            // æ¢å¤ç”»å¸ƒçŠ¶æ€
            ctx.restore();
        }
        
        function drawMonster(monster) {
            const ctx = canvas.getContext('2d');
            
            ctx.save();
            ctx.translate(monster.x + monster.width/2, monster.y + monster.height/2);
            
            let mainColor, detailColor;
            
            // æ ¹æ®æ€ªç‰©ç±»å‹è®¾ç½®é¢œè‰²
            switch(monster.type) {
                case 'strawberry':
                    mainColor = '#FF6B6B';
                    detailColor = '#8B0000';
                    break;
                case 'pineapple':
                    mainColor = '#FFD700';
                    detailColor = '#8B4513';
                    break;
                case 'grape':
                    mainColor = '#9B5DE5';
                    detailColor = '#4B0082';
                    break;
                case 'watermelon':
                    mainColor = '#06D6A0';
                    detailColor = '#028090';
                    break;
                default:
                    mainColor = '#FF6B6B';
                    detailColor = '#8B0000';
            }
            
            // æ€ªç‰©èº«ä½“
            ctx.fillStyle = mainColor;
            ctx.beginPath();
            
            if (monster.type === 'strawberry') {
                // è‰è“å½¢çŠ¶
                ctx.ellipse(0, 0, monster.width/2, monster.height/2, 0, 0, Math.PI * 2);
                
                // è‰è“ç±½
                ctx.fill();
                ctx.fillStyle = detailColor;
                for (let i = 0; i < 12; i++) {
                    const angle = (i / 12) * Math.PI * 2;
                    const x = Math.cos(angle) * monster.width/3;
                    const y = Math.sin(angle) * monster.height/3;
                    ctx.beginPath();
                    ctx.arc(x, y, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            } else if (monster.type === 'pineapple') {
                // è èå½¢çŠ¶
                ctx.rect(-monster.width/2, -monster.height/2, monster.width, monster.height);
                ctx.fill();
                
                // è èçº¹ç†
                ctx.strokeStyle = detailColor;
                ctx.lineWidth = 2;
                for (let i = -monster.width/2; i <= monster.width/2; i += 15) {
                    ctx.beginPath();
                    ctx.moveTo(i, -monster.height/2);
                    ctx.lineTo(i, monster.height/2);
                    ctx.stroke();
                }
                for (let i = -monster.height/2; i <= monster.height/2; i += 15) {
                    ctx.beginPath();
                    ctx.moveTo(-monster.width/2, i);
                    ctx.lineTo(monster.width/2, i);
                    ctx.stroke();
                }
            } else {
                // å…¶ä»–æ€ªç‰©åœ†å½¢
                ctx.arc(0, 0, monster.width/2, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // æ€ªç‰©çœ¼ç›
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(-10, -8, 6, 0, Math.PI * 2);
            ctx.arc(10, -8, 6, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(-8, -8, 3, 0, Math.PI * 2);
            ctx.arc(8, -8, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // æ€ªç‰©å˜´å·´
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, 5, 10, 0.2 * Math.PI, 0.8 * Math.PI);
            ctx.stroke();
            
            // å°–ç‰™
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.moveTo(-5, 10);
            ctx.lineTo(-2, 15);
            ctx.lineTo(1, 10);
            ctx.lineTo(4, 15);
            ctx.lineTo(7, 10);
            ctx.fill();
            
            ctx.restore();
        }
        
        function resizeCanvas() {
            const container = document.getElementById('gameContainer');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        // ==================== å¯åŠ¨æ¸¸æˆ ====================
        window.addEventListener('load', init);
    </script>
</body>
</html>